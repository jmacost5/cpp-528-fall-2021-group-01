---
title: "Lab04-Hedonic Housing Models-Ahmed Rashwan"
author: "Ahmed Rashwan"
date: "24/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

library( plyr)
library( dplyr )       # data wrangling
library( pander )      # nice tables 
library( mclust )      # cluster analysis 
library( ggplot2 )     # graphing 

library( DT )          # provides an R interface to the JavaScript library DataTables
library( knitr )       # Provides a general-purpose tool for dynamic report generation
library( stargazer )   # create a summary statistics table
library( scales )      # inverse of scaling, making guides (legends and axes) 

# maps
library( tidycensus)   # help R users get Census data that is pre-prepared for exploration
library( pals )        # Memory use is reduced by compressing colormaps to fewer colors
library( cartogram )   # spatial maps w/ tract size bias reduction
library( tidyverse)    # tidyverse makes data science faster, easier and more fun with
library( here)  
library(formattable)

customGreen0 = "#DeF7E9"

customGreen = "#71CA97"

customRed = "#ff7f7f"

```

```{r}
# set randomization seed ----
set.seed( 1234 )
# load necessary functions and objects ----
# note: all of these are R objects that will be used throughout this .rmd file
import::here("S_TYPE",
             "INFLATION_RATE",
             "panel.cor",
             "panel.smooth",
             "jplot",
             "d1",
             "d2",
             "d",
             "df",
             "md",
             "cbsa_stats_df",
             # notice the use of here::here() that points to the .R file
             # where all these R objects are created
             .from = here::here("labs/wk06/Unified_Data_Steps.R"),
             .character_only = TRUE)
```

### Part 1 

####Create a dataset that includes 2000 and 2010 census variables drop all rural census tracts.

#### Loading Data

```{r}

nrow( d1 ) 

```

#### save a copy of data for later use

```{r}

d.full<- d 

```

Store original in case you need to reset anything

```{r}

d <- d.full 

```

```{r}

df.select <- select( df, MedianHomeValue2010, MHV.Change.00.to.10,MHV.Growth.00.to.12)

formattable(head(df.select), 
            align =c("l","c","c","c","c", "c", "c", "c", "r"), 
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")),
              `MedianHomeValue2010`= color_tile(customGreen0, customGreen0),
              `MHV.Change.00.to.10`= color_tile(customGreen, customGreen),
              `MHV.Growth.00.to.12`= color_tile(customRed, customRed)
))

```
### Part 1 - Data

#### Create a variable that measures the growth of median home value from 2000 to 2010.

```{r}

head(d) %>% pander()

```

#### Omit cases that have a median home value less than $10,000 in 2000.

```{r}

#mhv.00[d$mhv.00 < 10000]

```

#### Omit cases with growth rates above 200%.

```{r}

#mhv.00[d$mhv.growth > 200] 

```

#### Median Home value

```{r}
hist( df$MedianHomeValue2000, breaks=200, xlim=c(0,500000), 
      col="gray20", border="white",
      axes=F, 
      xlab="MHV (median = $138k)",
      ylab="",
      main="Median Home Value in 2000 (2010 US dollars)" )
axis( side=1, at=seq(0,500000,100000), 
      labels=c("$0","$100k","$200k","$300k","$400k","$500k") )
abline( v=median( df$MedianHomeValue2000, na.rm=T ), col="orange", lwd=3 )

```

#### Change Value in Median Home Value 2000 to 2010

```{r}
hist( df$MHV.Change.00.to.10/1000, breaks=500, 
      xlim=c(-100,500), yaxt="n", xaxt="n",
      xlab="Thousand of US Dollars (adjusted to 2010)", cex.lab=1.5,
      ylab="", main="Change in Median Home Value 2000 to 2010",
      col="gray20", border="white" )
axis( side=1, at=seq( from=-100, to=500, by=100 ), 
      labels=paste0( "$", seq( from=-100, to=500, by=100 ), "k" ) )
        
mean.x <- mean( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=200, y=1500, 
      labels=paste0( "Mean = ", dollar( round(1000*mean.x,0)) ), 
      col="darkorange", cex=1.6, pos=3 )
median.x <- median( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=200, y=2000, 
      labels=paste0( "Median = ", dollar( round(1000*median.x,0)) ), 
      col="dodgerblue", cex=1.6, pos=3 )

```


#### Growth Percentage in Home Value by Census Tract 2000 to 2010

```{r ,eval=FALSE}

hg <-
hist( df$MHV.Growth.00.to.12, breaks=5000, 
      xlim=c(-100,200), yaxt="n", xaxt="n",
      xlab="", cex.main=1.5,
      ylab="", main="Growth in Home Value by Census Tract 2000 to 2010",
      col="gray40", border="white" )
axis( side=1, at=seq( from=-100, to=200, by=50 ), 
      labels=paste0( seq( from=-100, to=200, by=50 ), "%" ) )
ymax <- max( hg$count )
        
mean.x <- mean( df$MHV.Growth.00.to.12, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=100, y=(0.5*ymax), 
      labels=paste0( "Mean = ", round(mean.x,0), "%"), 
      col="darkorange", cex=1.6, pos=4 )
median.x <- median( df$MHV.Growth.00.to.12, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=100, y=(0.6*ymax), 
      labels=paste0( "Median = ", round(median.x,0), "%"), 
      col="dodgerblue", cex=1.6, pos=4 )

```

#### Change in Median Home Value \n2000 to 2010

```{r}

hist( df$MHV.Change.00.to.10/1000, breaks=500, 
      xlim=c(-100,500), yaxt="n", xaxt="n",
      xlab="Thousand of US Dollars (adjusted to 2010)", cex.lab=1.5,
      ylab="", main="Change in Median Home Value 2000 to 2010",
      col="gray20", border="white" )
axis( side=1, at=seq( from=-100, to=500, by=100 ), 
      labels=paste0( "$", seq( from=-100, to=500, by=100 ), "k" ) )
        
mean.x <- mean( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=200, y=1500, 
      labels=paste0( "Mean = ", dollar( round(1000*mean.x,0)) ), 
      col="darkorange", cex=1.6, pos=3 )
median.x <- median( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=200, y=2000, 
      labels=paste0( "Median = ", dollar( round(1000*median.x,0)) ), 
      col="dodgerblue", cex=1.6, pos=3 )

```

### Part 2 - Predict MHV Change

#### Select at least three census variables that you feel will be good predictors of change in MHV between 2000 and 2010.

**1-Percent white (p.white.00)**

**2-Percent professional employees (p.prof)**

**3-Percent of properties vacant in year 2000 (p.vacant)**

#### Run the model while including metro-level fixed effects (cbsa name or FIPS). Make sure you check for variable skew and multicollinearity and adjust accordingly.

#### Variables Skew

```{r}

hist( d$p.white.00 )

```

```{r}

hist( d$p.prof )

```

```{r}

hist( d$p.vacant )

```

**Vacant properties variable is skewed to be logged**

```{r}
d$p.vacant.log <- log( d$p.vacant + 1 )
hist( d$p.vacant.log )
```

#### Addressing Skew in Census Data:

```{r}
# create subset to visualize in correlation matrix 
d9 <- select( d, p.white.00 , p.prof , p.vacant )
# reduce data density for visualization
set.seed( 1234 )
d10 <- sample_n( d9, 10000 ) %>% na.omit()
# correlation plots
pairs( d10, upper.panel=panel.cor, lower.panel=panel.smooth )

```
**After applying log transformations note that the bivariate correlations increase except for relationship between MHV and (mhv.growth) vacancy rates (p.vacant):**

```{r}

set.seed( 1234 )
d9 <- select( d, mhv.growth, p.white.00, p.prof,  p.vacant )
# recode some vars to remove outliers and skew
d9$mhv.growth[ d9$mhv.growth > 200 ] <- NA
d9$p.white.00 <- log10( d9$p.white.00 + 1 )
d9$p.prof <- log10( d9$p.prof + 1  )
d9$p.vacant <- log10( d9$p.vacant + 1 )
d11 <- sample_n( d9, 5000 ) %>% na.omit()
pairs( d11, upper.panel=panel.cor, lower.panel=panel.smooth )

```


#### check multicollinearity between variables

```{r}

cor( d$p.white.00, d$p.prof, use="pairwise.complete" )

```

```{r}

cor( d$p.white.00, d$p.vacant, use="pairwise.complete" )

```

```{r}

cor( d$p.prof, d$p.vacant, use="pairwise.complete" )

```

##### Create a correlation plot for your three variables to check wether some variables are highly-correlated?

**Answer : None of the variables has a correlation above that cases Multicollinearity **

#### Create a relationship scatterplot between each variable & MHV Growth 2000-2010

```{r}

jplot( d$p.white.00, d$mhv.growth, ylim=c(-100,200), 
       lab1="Percent White", lab2="MHV Growth 2000-2010" )

```

```{r}

jplot( d$p.prof, d$mhv.growth, ylim=c(-100,200), 
       lab1="Percent Professional employees", lab2="MHV Growth 2000-2010" )

```

```{r}

jplot( d$p.vacant.log, d$mhv.growth, ylim=c(-100,200), 
       lab1="Percent Vacant Properties", lab2="MHV Growth 2000-2010" )

```

### Interpret a Regression Coefficient.

```{r}

reg.data <- d
# remove outliers and skew
reg.data$mhv.growth[ reg.data$mhv.growth > 200 ] <- NA
reg.data$p.white.00 <- log10( reg.data$p.white.00 + 1 )
reg.data$p.prof <- log10( reg.data$p.prof + 1 )
reg.data$p.vacant.log  <- log10( reg.data$p.vacant  + 1 )

m1 <- lm( mhv.growth ~  p.white.00 , data=reg.data )
m2 <- lm( mhv.growth ~  p.prof, data=reg.data )
m3 <- lm( mhv.growth ~  p.vacant.log, data=reg.data )
m4 <- lm( mhv.growth ~  p.white.00  + p.prof + p.vacant.log, data=reg.data )


stargazer( m1, m2, m3, m4 ,
           type=S_TYPE, digits=2,
           omit.stat = c("rsq","f") )

```


### Descriptives

```{r}

df <- data.frame( MedianHomeValue2000=d$mhv.00, 
                  MedianHomeValue2010=d$mhv.10, 
                  MHV.Change.00.to.10=d$mhv.change,
                  MHV.Growth.00.to.12=d$mhv.growth, 
                  Percent.White=d$p.white.00,
                  Percent.Professional=d$p.prof,
                  Percent.Vacant=d$p.vacant.log)

stats.for.table <- c("min", "p25","median","mean","p75","max")

stargazer( df, 
           type=S_TYPE, 
           digits=0, 
           summary.stat = stats.for.table )

```

#### view results

```{r}

cbsa_stats_df %>% head()

```

```{r}
d12 <- filter( d, cbsaname %in% 
                c("Abilene, TX",
                  "Albany-Schenectady-Troy, NY",
                  "Alexandria, LA") )
d12$cbsaname <- factor( d12$cbsaname, labels=c("Ty-NY","Alx-LA","Abl-TX") )
par( mar=c(4,6,4,6), mfrow=c(1,2) )
plot( d12$cbsaname,  d12$mhv.00, las=1, frame.plot=F, outline=F,
      xlab="", ylab="", main="Home Values in 2000" )
abline( h=seq(0,1200000,100000), lty=3, col=gray(0.5,0.3) )
axis( side=4, las=1 )
plot( d12$cbsaname,  d12$p.prof, las=1, frame.plot=F, outline=F,
      xlab="", ylab="", main="Professionals Rates in 2000" )
abline( h=seq(0,15,1), lty=3, col=gray(0.5,0.3) )
axis( side=4, las=1 )

```


```{r}

d12 <- filter( d, cbsaname %in%
                c("Abilene,TX",
                  "Albany-Schenectady-Troy, NY",
                  "Alexandria, LA") )
d12$mhv.growth[ d12$mhv.growth > 200 ] <- NA
d12$p.prof <- log10( d12$p.prof + 1 )
x <- rnorm( nrow(d12), 0, 0.1 ) +
     as.numeric( d12$cbsaname == "Abilene, TX" ) + 
     2 * as.numeric( d12$cbsaname == "Albany-Schenectady-Troy, NY" ) + 
     3* as.numeric( d12$cbsaname == "Alexandria, LA" ) 
par( mfrow=c(1,2) )
plot( x, d12$mhv.growth, 
      pch=19, cex=1.5, bty = "n",  
        col=factor(d12$cbsa),
      ylim=c(-50,50),
      xaxt="n", 
      ylab="", xlab="",
      main="MHV Growth")
axis( side=1, at=1:3, labels=c("Abilene","Schenectady","Alexandria"), 
      tick=F, col.axis="gray60", cex.axis=1.3 )
plot( x, d12$p.prof, 
      pch=19, cex=1.5, bty = "n",  
        col=factor(d12$cbsa),
      # ylim=c(0,40),
      xaxt="n", 
      ylab="", xlab="",
      main="Professionals (logged)")
axis( side=1, at=1:3, labels=c("Abilene","Schenectady","Alexandria"), 
      tick=F, col.axis="gray60", cex.axis=1.3 )

```
**result in different baseline metro-level home value growth rates in a model when each city is given its own intercep**

```{r}

d12 <- filter( d, cbsaname %in% 
              c("Abilene, TX",
                 "Albany-Schenectady-Troy, NY",
                 "Alexandria, LA") )

d12$mhv.growth[ d12$mhv.growth > 200 ] <- NA
d12$p.prof <- log10( d12$p.prof + 1 )
m <- lm( mhv.growth ~ factor(cbsaname) + p.prof - 1, data=d12 )
b0.Abilene   <- m$coefficients[1] 
b0.Schenectady    <- m$coefficients[2] 
b0.Alexandria <- m$coefficients[3] 
b1            <- m$coefficients[4] 
palette( c( "steelblue", "green3", "darkorange"  ) )
palette( adjustcolor( palette(), alpha.f = 0.3 ) )
plot( d12$p.prof, d12$mhv.growth,
        pch=19, cex=1.5, bty = "n",  
        col=factor(d12$cbsa),
      ylim=c(-100,100),
      xlab="Professionals Rate (logged)",
      ylab="Median Home Value Growth 2000-2010")
          
abline( b0.Abilene, b1, col="steelblue", lwd=3 )
abline( b0.Schenectady, b1, col="green3", lwd=3 )
abline( b0.Alexandria, b1, col="darkorange", lwd=3 )


```

**We account for context by adding a metro-level fixed effect to the model. Alternatively, we can add the average median home value growth of the metro area as a control variable:**

```{r}

d.reg <- d
d.reg$mhv.growth[ d.reg$mhv.growth > 200 ] <- NA
d.reg$p.prof <- log10( d.reg$p.prof + 1 )
# average growth in median home value for the city
d.reg <- 
  d.reg %>%
  group_by( cbsaname ) %>%
  mutate( metro.mhv.growth = 100 * median( mhv.growth, na.rm=T ) ) %>%
  ungroup() 
m1 <- lm( mhv.growth ~ p.prof, data=d.reg )
m2 <- lm( mhv.growth ~ p.prof + metro.mhv.growth, data=d.reg )
m3 <- lm( mhv.growth ~ p.prof + cbsa, data=d.reg )
stargazer( m1, m2, m3, 
           type=S_TYPE, digits=2,
           omit.stat = c("rsq","f"),
           omit="cbsa",
           add.lines = list(c("Metro Fixed Effects:", "NO", "NO","YES")) )


```

#### What are the results? Which factor was most important? Did it meet your expectations? Were there any variables that were not significant that you expected to be?

##### Explain your findings to a general audience.

**The relationship between the number of people employed in high-paying professional professions and the growth in property prices had the predicted beneficial effect.**

**The proportion of white people in the tract was the total opposite of what was predicted. In 2000, there were more white people, which predicted smaller gains in property value and growth rates between 2000 and 2010.**

**The relationship between housing vacancy and growth turned out to be more complicated than expected.**

**All three relationships are statistically significant at an alpha=0.05 level.**










---
title: "Lab05_Ahmed_Rashwan"
author: "Ahmed Rashwan"
output:
  html_document:
    theme: readable
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r , warning=FALSE}

library( plyr)
library( dplyr )       # data wrangling
library( pander )      # nice tables 
library( mclust )      # cluster analysis 
library( ggplot2 )     # graphing 

library( DT )          # provides an R interface to the JavaScript library DataTables
library( knitr )       # Provides a general-purpose tool for dynamic report generation
library( stargazer )   # create a summary statistics table
library( scales )      # inverse of scaling, making guides (legends and axes) 

# maps
library( tidycensus)   # help R users get Census data that is pre-prepared for exploration
library( pals )        # Memory use is reduced by compressing colormaps to fewer colors
library( cartogram )   # spatial maps w/ tract size bias reduction
library( tidyverse)    # tidyverse makes data science faster, easier and more fun with
library( here)  
library(formattable)

customGreen0 = "#DeF7E9"

customGreen = "#71CA97"

customRed = "#ff7f7f"

```

```{r , , warning=FALSE}
# load necessary functions and objects ----
# note: all of these are R objects that will be used throughout this .rmd file
import::here("S_TYPE",
             "panel.cor",
             "panel.smooth",
             "d",
             "df",
             "d5",
             "d8",
             "PLOTS",
             "%>%",
             # notice the use of here::here() that points to the .R file
             # where all these R objects are created
             .from = here::here("labs/wk06/Unified_Data_Steps.R"),
             .character_only = TRUE)

```

#### Saving our rodeo file into rodeo file 


```{r , eval=FALSE}

saveRDS(d,here("data/rodeo/rodeo-data-AR.rds"))

```

#### Loading our d file from the rds format 

```{r ,eval=FALSE, warning=FALSE}

readRDS(file=here("data/rodeo/rodeo-data-AR.rds"))

```

#### Loading Data Manifest from our rodeo folder 

```{r , eval=FALSE,  warning=FALSE}
# Year 2000 Data
ltdb.raw.2000s <- read.csv(here("data/raw/ltdb_std_2000_sample.csv"))
ltdb.raw.2000f <- read.csv(here("data/raw/LTDB_Std_2000_fullcount.csv"))
ltdb.rodeo.2000 <- readRDS(here("data/rodeo/LTDB-2000.rds"))

# Year 2010 Data
ltdb.raw.2010s <- read.csv(here("data/raw/ltdb_std_2010_sample.csv"))
ltdb.raw.2010f <- read.csv(here("data/raw/LTDB_Std_2010_fullcount.csv"))
ltdb.rodeo.2010 <- readRDS(here("data/rodeo/LTDB-2010.rds"))

complete.rodeo <-readRDS(file=here("data/rodeo/rodeo-data-AR.rds"))

```


```{r , warning=FALSE}

head(d) %>% pander()

```
#### Stats of Both Years

```{r, warning=FALSE}

df <- select( df, MedianHomeValue2000,MedianHomeValue2010,MHV.Change.00.to.10,MHV.Growth.00.to.12)

formattable(head(df), 
            align =c("l","c","c","c","c", "c", "c", "c", "r"), 
            list(`Indicator Name` = formatter(
            "span", style = ~ style(color = "grey",font.weight = "bold")),
            `MedianHomeValue2000`= color_tile(customGreen, customGreen),
            `MedianHomeValue2010`= color_tile(customGreen0, customGreen0),
            `MHV.Change.00.to.10`= color_tile(customGreen, customGreen),
            `MHV.Growth.00.to.12`= color_tile(customRed, customRed)
))

```

#### Median Home value 2000 

```{r , warning=FALSE}
hist( df$MedianHomeValue2000, breaks=200, xlim=c(0,500000), 
      col="gray20", border="white",
      axes=F, 
      xlab="MHV (median = $138k)",
      ylab="",
      main="Median Home Value in 2000 ( 2010 US dollars)" )
axis( side=1, at=seq(0,500000,100000), 
      labels=c("$0","$100k","$200k","$300k","$400k","$500k") )
abline( v=median(df$MedianHomeValue2000, na.rm=T ), col="orange", lwd=3 )

```

#### Median Home value 2010

```{r, warning=FALSE}
hist( df$MedianHomeValue2010, breaks=200, xlim=c(0,500000), 
      col="gray20", border="white",
      axes=F, 
      xlab="MHV (median = $155k)",
      ylab="",
      main="Median Home Value in 2010 ( 2010 US dollars)" )
axis( side=1, at=seq(0,500000,100000), 
      labels=c("$0","$100k","$200k","$300k","$400k","$500k") )
abline( v=median(df$MedianHomeValue2010, na.rm=T ), col="orange", lwd=3 )

```

#### Change Value in Median Home Value 2000 to 2010

```{r, warning=FALSE}
hist( df$MHV.Change.00.to.10/1000, breaks=500, 
      xlim=c(-100,500), yaxt="n", xaxt="n",
      xlab="Thousand of US Dollars (adjusted to 2010)", cex.lab=1.5,
      ylab="", main="Change in Median Home Value 2000 to 2010",
      col="gray20", border="white" )
axis( side=1, at=seq( from=-100, to=500, by=100 ), 
      labels=paste0( "$", seq( from=-100, to=500, by=100 ), "k" ) )
        
mean.x <- mean( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=200, y=1500, 
      labels=paste0( "Mean = ", dollar( round(1000*mean.x,0)) ), 
      col="darkorange", cex=1.5, pos=3 )
median.x <- median( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=200, y=2000, 
      labels=paste0( "Median = ", dollar( round(1000*median.x,0)) ), 
      col="dodgerblue", cex=1.5, pos=3 )

```



#### Growth Percentage in Home Value by Census Tract 2000 to 2010

```{r , warning=FALSE}

hg <-
hist( df$MHV.Growth.00.to.12, breaks=5000, 
      xlim=c(-100,200), yaxt="n", xaxt="n",
      xlab="", cex.main=1.5,
      ylab="", main="Growth in Home Value by Census Tract 2000 to 2010",
      col="gray40", border="white" )
axis( side=1, at=seq( from=-100, to=200, by=50 ), 
      labels=paste0( seq( from=-100, to=200, by=50 ), "%" ) )
ymax <- max( hg$count )
        
mean.x <- mean( df$MHV.Growth.00.to.12, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=100, y=(0.5*ymax), 
      labels=paste0( "Mean = ", round(mean.x,0), "%"), 
      col="darkorange", cex=1.5, pos=4 )
median.x <- median( df$MHV.Growth.00.to.12, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=100, y=(0.6*ymax), 
      labels=paste0( "Median = ", round(median.x,0), "%"), 
      col="dodgerblue", cex=1.5, pos=4 )

```

####  Descriptive Statistics


```{r, warning=FALSE }
stargazer::stargazer( df, 
                      type=S_TYPE, 
                      digits=0, 
                      summary.stat = c("min", "p25","median","mean","p75","max") )

```

###  Bivariate Correlation 

```{r, warning=FALSE}

df.instrument <- select(d, mhv.growth , p.white.00 ,p.vacant,p.prof.00) %>%na.omit()

```
#### Correlation Plot for selected instruments

```{r, warning=FALSE}

set.seed(1234)
df.instrument$p.white.00 <- log10( df.instrument$p.white.00 + 1 )
df.instrument$p.vacant <- log10( df.instrument$p.vacant + 1  )
df.instrument$p.prof.00 <- log10( df.instrument$p.prof.00 + 1 )
# correlation plots
pairs( df.instrument, lower.panel=panel.smooth,upper.panel=panel.cor )

```

#### Variables Skew

```{r, warning=FALSE}

hist( d$p.white.00 )

```

```{r, warning=FALSE}

hist( d$p.prof.00 )

```

```{r, warning=FALSE}

hist( d$p.vacant )

```


###  Variable Regression Analysis

```{r, warning=FALSE}

reggres <- lm(mhv.growth ~ p.white.00 + p.vacant + p.prof.00 , data = df.instrument)

stargazer(reggres, type = S_TYPE, dep.var.labels = ("Median Home Value change 2000-2010"),
    digits = 2)

```

###  Program Participation Criteria


####  DATA TO BE USED FOR THE DIFF-DIFF MODEL 

```{r, warning=FALSE}
#  DATA TO BE USED FOR THE DIFF-DIFF MODEL FOR NMTC PROGRAM

head(d5) %>% pander()

#  DATA TO BE USED FOR THE DIFF-DIFF MODEL FOR LIHTC PROGRAM

head(d8) %>% pander()

```

#### Recipient and Non-Recipient Tracts:

#### We can look at some descriptive statistics from 2000 to determine if we have an apples to oranges type of comparison:

```{r, warning=FALSE}
### POVERTY RATES
gridExtra::grid.arrange( PLOTS$pov_rate_2000$nmtc, 
                         PLOTS$pov_rate_2000$lihtc,
                         nrow = 1 )
```

##### New Market Tax Credit recipients appear to be quite distinct, located in poorer tracts. We see the LIHTC projects tend to favor tracts with higher poverty than non-recipient tracts, but a large proportion of the projects are still located in tracts with low to moderate levels of poverty.


```{r, warning=FALSE}
### HOME VALUES
gridExtra::grid.arrange( PLOTS$mhv_2000$nmtc, 
                         PLOTS$mhv_2000$lihtc, 
                         nrow = 1 )
```


##### When comparing recipient tracts to non-recipient tracts we can see very clearly that they are different. The degree depends on the program, NMTC seem to be very distinctive, and LIHTC still different but not as pronounced.

### Here are some more summary statistics comparing the two:

**Household Income 2000 Variable:**

#### LIHTC Program

```{r, warning=FALSE}
### HOUSEHOLD INCOME COMPARISONIN 2000:
### PROGRAM RECIPIENTS VS NON-RECIPIENT TRACTS

# Tracts that received LIHTC
mean( d$hinc00[ d$num.lihtc > 0 ] )
```

```{r, warning=FALSE}

# Tracts that did not received LIHT 
mean( d$hinc00[ d$num.lihtc == 0 ] )

```

#### NMTC Program

```{r, warning=FALSE}

# Tracts that received NMTC
mean( d$hinc00[ d$num.nmtc > 0 ] )

```


**Home Value 2000 Variable:**

#### LIHTC Program

```{r, warning=FALSE}

### MEDIAN HOME VALUE COMPARISON IN 2000

# Tracts that received LIHTC
mean( d$mhv.00[ d$num.lihtc > 0 ], na.rm=T )

```


```{r, warning=FALSE}

# Tracts that did not received LIHTC

mean( d$mhv.00[ d$num.lihtc == 0 ], na.rm=T )

```

#### NMTC Program

```{r, warning=FALSE}

# Tracts that received NMTC
mean( d$mhv.00[ d$num.nmtc > 0 ], na.rm=T )

```


```{r, warning=FALSE}

# Tracts that did not received NMTC
mean( d$mhv.00[ d$num.nmtc == 0 ], na.rm=T )

```

**Poverty Rates 2000 Variable:**

#### LIHTC Program

```{r, warning=FALSE}

### POVERTY RATE COMPARISONS

# Tracts that received LIHTC
summary( d$pov.rate.00[ d$num.lihtc > 0 ] )

```

```{r, warning=FALSE}

### POVERTY RATE COMPARISONS

# Tracts that did not received LIHTC
summary( d$pov.rate.00[ d$num.lihtc == 0 ] )

```

#### NMTC Program

```{r, warning=FALSE}

### POVERTY RATE COMPARISONS

# Tracts that received NMTC
summary( d$pov.rate.00[ d$num.nmtc > 0 ] )

```

```{r, warning=FALSE}

### POVERTY RATE COMPARISONS

# Tracts that did not received NMTC
summary( d$pov.rate.00[ d$num.nmtc == 0 ] )
```

**DV of MHV growth rates Variable:**

### And examining the DV of MHV growth rates to get a sense of the distribution of the outcome prior to running regression models:

```{r, warning=FALSE}

### MHV Growth Rates (DV in Model)
gridExtra::grid.arrange( PLOTS$mhv_growth$lihtc, 
                         PLOTS$mhv_growth$nmtc, 
                         nrow = 1 )

```

**LIHTC on the left is a bit misleading since there is greater density for program participant tracts in the right tail (evidence of higher treatment growth), but there is also some more density for non-participant tracts in the peak left of the distribution. It's difficult to judge visually.**

**NMTC, on the other hand, appears to be in better shape because to the high density in the right side.**

**We can confirm these with some descriptive statistics of home value growth rates:**

#### LIHTC Program

```{r, warning=FALSE}

# Tracts that received LIHTC
summary( d$growth[ d$num.lihtc > 0 ] )

```

```{r, warning=FALSE}

# Tracts that did not received LIHTC
summary( d$growth[ d$num.lihtc == 0 ] )


```


#### NMTC Program


```{r, warning=FALSE}

# Tracts that received NMTC
summary( d$growth[ d$num.nmtc > 0 ] )


```


```{r, warning=FALSE}

# Tracts that did not received NMTC
summary( d$growth[ d$num.nmtc == 0 ] )


```

**Home value growth rates for LIHTC program participant and non-participant tracts are almost the same.**

**Home value growth rates for NMTC participants are significant higher than non-participant tracts. These are unconditional means with no real counterfactual, so we still need to create an evaluation framework. But they offer some suggestive evidence.**



### Evaluating Program Impact for NMTC Program


```{r, warning=FALSE}
m <- lm( y ~  treat + post +  treat*post, data=d5 )
# display model results
stargazer::stargazer(m,
                     type = S_TYPE,
                     digits = 2)

```

```{r, warning=FALSE}

# Exponentiate coefficients to recover the mean:

b0 <- m$coefficients[1] 
b1 <- m$coefficients[2]
b2 <- m$coefficients[3]
b3 <- m$coefficients[4]

# C1 = B0  
exp( b0 )

```

```{r, warning=FALSE}
# C2 = B0 + B2 
exp( b0 + b2 )

```

```{r, warning=FALSE}

# T1 = B0 + B1 
exp( b0 + b1 )

```

```{r, warning=FALSE}

# T2 = B0 + B1 + B2 + B3 
exp( b0+b1+b2+b3 )

```




### Evaluating Program Impact for LIHTC Program


```{r, warning=FALSE}
m2 <- lm( y ~  treat2 + post2 +  treat2*post2, data=d8 )
# display model results
stargazer::stargazer(m2,
                     type = S_TYPE,
                     digits = 2)

```

```{r, warning=FALSE}

# Exponentiate coefficients to recover the mean:

b0 <- m2$coefficients[1] 
b1 <- m2$coefficients[2]
b2 <- m2$coefficients[3]
b3 <- m2$coefficients[4]

# C1 = B0  
exp( b0 )

```


```{r, warning=FALSE}
# C2 = B0 + B2 
exp( b0 + b2 )

```


```{r, warning=FALSE}

# T1 = B0 + B1 
exp( b0 + b1 )

```


```{r, warning=FALSE}

# T2 = B0 + B1 + B2 + B3 
exp( b0+b1+b2+b3 )

```


#### Are the programs effective at catalyzing neighborhood improvement? 

**The rise in your home's value There is only one data point for the whole study periodTwo data points are required for the diff-in-diff method before and after the treatment. Means tests are used to determine eligibility for the NMTC, which needs a poverty rate of at least 20% and a median household income of less than 80% of the metro area median.**
**We could perform something similar with the NMTC data, finding all of the tracts with poverty rates over 20% but earnings slightly above 80% of the metro average, or those with poverty rates slightly below 20% but wages below 80% of the metro average.**
**The LIHTC program, on the other hand, does not have a means-test. As a result, this strategy is ineffective.**





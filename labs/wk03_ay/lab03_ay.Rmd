---
title: "Lab 03"
author: "Alev Yildiz"
date: "11/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("import")

#load and unload here package to reset it for use in the lab
library(here)
detach("package:here", unload = TRUE)
```

```{r}

library( dplyr )
library( knitr )
library( pander )
library( stargazer )
library( scales )
library(sp)
library( here )
library(ggplot2)
# set stargazer type to text for 
# previewing in RMD docs but
# convert to type HTML when knitting
# (next code chunk)

s.type <- "text"  
```


```{r}
# Load cleaned data using here::here()

d1 <- readRDS( here::here( "data/rodeo/LTDB-1990.rds" ) )
d2 <- readRDS( here::here( "data/rodeo/LTDB-2000.rds" ) )
md <- readRDS( here::here( "data/rodeo/LTDB-META-DATA.rds" ) )

# check to make sure we are not losing 
# or gaining observations in the merge
nrow( d1 ) 
```


```{r}

#import specific functions that will be used throughout this .rmd file

import::here("clean_d",
             "tidy_up_data",
             "build_year",
             "RELEVANT_FILES",
             "obtain_crosswalk",
             "create_final_metadata_file",
             "jplot",
             # notice the use of here::here() that points to the .R file
             # where all these R objects are created
             .from = here::here("labs/wk03_ay/lab03_utilities_ay.R"),
             .character_only = TRUE)
```

# Part 01 - Change in Home

# The results show that home values lost value between 1990-2000 however it rebounded markedly since 2000 by return of college educated whites. The authors predict that decrease in population also deteriorated nearby labor market opportunities for low skilled whites. 

```{r}
d1 <- select( d1, - year )
d2 <- select( d2, - year )

d <- merge( d1, d2, by="tractid" )
d <- merge( d, md, by="tractid" )

```


```{r}

# Select urban 
d <- filter( d, urban == "urban" )

```


#Identify Common Variables

```{r}

vars <- compare_dfs( df1=d1, df2=d2 )

head(vars, 5)
```
# Create Dataset for Analysis

```{r}
d.full <- d
```

```{r}
d <- d.full  # store original in case you need to reset anything

d <- select( d, tractid, mhmval90, mhmval00, hinc90, 
             hu90, own90, rent90,  
             empclf90, clf90, unemp90, prof90,  
             dpov90, npov90,
             ag25up90, hs90, col90, 
             pop90.x, nhwht90, nhblk90, hisp90, asian90,
             cbsa, cbsaname )
d <- 
  d %>%
  mutate( p.white = 100 * nhwht90 / pop90.x,
          p.black = 100 * nhblk90 / pop90.x,
          p.hisp = 100 * hisp90 / pop90.x, 
          p.asian = 100 * asian90 / pop90.x,
          p.hs = 100 * (hs90+col90) / ag25up90,
          p.col = 100 * col90 / ag25up90,
          p.prof = 100 * prof90 / empclf90,
          p.unemp = 100 * unemp90 / clf90,
          pov.rate = 100 * npov90 / dpov90 )

```


```{r}
stargazer( d, 
           type=s.type, 
           digits=0,
           summary.stat = c("min", "p25","median","mean","p75","max") )
```



# Exploration of Median Home Value Initial condition in 1990

```{r}
# adjust 1990 home values for inflation 
mhv.00 <- d$mhmval00  
mhv.90 <- d$mhmval90 * 1.34 


# change in MHV in dollars
mhv.change <- mhv.00 - mhv.90

df <- data.frame( MedianHomeValue1990=mhv.90, 
                  MedianHomeValue2000=mhv.00, 
                  Change.90.to.00=mhv.change )


stargazer( df, 
           type=s.type, 
           digits=0, 
           summary.stat = c("min", "p25","median","mean","p75","max") )

```

# Histogram of MHV

```{r}
hist( mhv.change/1000, breaks=500, 
      xlim=c(-100,500), yaxt="n", xaxt="n",
      xlab="Thousand of US Dollars (adjusted to 2000)", cex.lab=1.5,
      ylab="", main="Change in Median Home Value 1990 to 2000",
      col="gray20", border="white" )

axis( side=1, at=seq( from=-100, to=500, by=100 ), 
      labels=paste0( "$", seq( from=-100, to=500, by=100 ), "k" ) )
        
mean.x <- mean( mhv.change/1000, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=200, y=1500, 
      labels=paste0( "Mean = ", dollar( round(1000*mean.x,0)) ), 
      col="darkorange", cex=1.8, pos=3 )

median.x <- median( mhv.change/1000, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=200, y=2000, 
      labels=paste0( "Median = ", dollar( round(1000*median.x,0)) ), 
      col="dodgerblue", cex=1.8, pos=3 )
```
```{r}
layout.matrix <- matrix( c( 1,3,
                            2,3 ), 
                nrow=2, ncol=2, byrow=T )

layout( mat = layout.matrix,
        heights = c(2,2), # Heights of the two rows
        widths =  c(3,4)) # Widths of the two columns

# layout.show(3)

par( mar=c(4,0,0,2) )

hist( mhv.90/1000, breaks=50, 
      xlim=c(-200,800), yaxt="n", xaxt="n",
      xlab="", cex.lab=1,
      ylab="", main="",
      col="darkslateblue", border="white" )

axis( side=1, at=seq( from=0, to=1000, by=100 ), 
      labels=paste0( "$", seq( from=0, to=1000, by=100 ), "k" ) )

abline( v=seq(0,1000,100), lty=2, col="gray80" )

text( 550, 4000, labels="Median Home \nValue in 1990", 
      col="darkslateblue", cex=1.8 )



hist( mhv.00/1000, breaks=50, 
      xlim=c(-200,800), yaxt="n", xaxt="n",
      xlab="", cex.lab=1,
      ylab="", main="",
      col="darkslateblue", border="white" )

abline( v=seq(0,1000, 100 ), lty=2, col="gray80" )

text( 550, 3500, labels="Median Home \nValue in 2000", 
      col="darkslateblue", cex=1.8 )

axis( side=1, at=seq( from=0, to=1000, by=100 ), 
      labels=paste0( "$", seq( from=0, to=1000, by=100 ), "k" ) )


# data reduction - filter 1,000 observations

df <- data.frame( v90=mhv.90/1000, v00=mhv.00/1000 )
df <- sample_n( df, 1000 )

par( mar=c(4,5,3,2) )

jplot( df$v90, df$v00, aes(lab1="MHV in 1990", lab2="MHV in 2000",
       xlim=c(0,1000), ylim=c(0,1000),
       axes=F) )

abline( a=0, b=1, lty=2, col="gray" )
axis( side=1, at=seq( from=0, to=1000, by=200 ), 
      labels=paste0( "$", seq( from=0, to=1000, by=200 ), "k" ) )
axis( side=2, at=seq( from=0, to=1000, by=200 ), 
      labels=paste0( "$", seq( from=0, to=1000, by=200 ), "k" ) )

```
#Change in MHV 1990-2000

```{r}
mhv.90[ mhv.90 < 10000 ] <- NA
pct.change <- mhv.change / mhv.90
summary( pct.change )
```

```{r}
# how many cases had increases above 500%
sum( pct.change > 5, na.rm=T )
```


#Part 02 - Measuring Gentrification

```{r}
# adjust 1990 home values for inflation 
mhv.90 <- d$mhmval90 * 1.31 
mhv.00 <- d$mhmval00

mhv.change <- mhv.00 - mhv.90

# small initial values are skewing percentages
#
# an average home value below $10k is really low -
# these must be mostly vacant lots?

mhv.90[ mhv.90 < 10000 ] <- NA
pct.change <- 100 * ( mhv.change / mhv.90 )
summary( pct.change )
```

```{r}
d.full$mhv.90 <- mhv.90
d.full$mhv.00 <- mhv.00
d.full$mhv.change <- mhv.change
d.full$pct.change <- pct.change
```

```{r}
d3 <- select( d.full, 
             
             tractid, cbsa, cbsaname,            # ids / units of analysis
             
             mhv.90, mhv.00, mhv.change, pct.change,    # home value 
             
             hinc90, hu90, own90, rent90,        # ses
             hinc00, hu00, own00, rent00,
             
             empclf90, clf90, unemp90, prof90,   # employment 
             empclf00, clf00, unemp00, prof00,
             
             dpov90, npov90,                     # poverty
             dpov00, npov00,
             
             ag25up90, hs90, col90,              # education 
             ag25up00, hs00, col00,
             
             pop90.x, nhwht90, nhblk90, hisp90, asian90,   # race
             pop00.x, nhwht00, nhblk00, hisp00, asian00
             
          ) # end select
```


```{r}
d3 <- 
  d3 %>%
  mutate( 
          # 1990 variables
          p.white.90 = 100 * nhwht90 / pop90.x,
          p.black.90 = 100 * nhblk90 / pop90.x,
          p.hisp.90 = 100 * hisp90 / pop90.x, 
          p.asian.90 = 100 * asian90 / pop90.x,
          p.hs.edu.90 = 100 * (hs90+col90) / ag25up90,
          p.col.edu.90 = 100 * col90 / ag25up90,
          p.prof.90 = 100 * prof90 / empclf90,
          p.unemp.90 = 100 * unemp90 / clf90,
          pov.rate.90 = 100 * npov90 / dpov90,
          
          # 2000 variables
          p.white.00 = 100 * nhwht00 / pop00.x,
          p.black.00 = 100 * nhblk00 / pop00.x,
          p.hisp.00 = 100 * hisp00 / pop00.x, 
          p.asian.00 = 100 * asian00 / pop00.x,
          p.hs.edu.00 = 100 * (hs00+col00) / ag25up00,
          p.col.edu.00 = 100 * col00 / ag25up00,
          p.prof.00 = 100 * prof00 / empclf00,
          p.unemp.00 = 100 * unemp00 / clf00,
          pov.rate.00 = 100 * npov00 / dpov00 )
```


```{r}
d3 <-
  d3 %>%
  group_by( cbsaname ) %>%
  mutate( metro.mhv.pct.90 = ntile( mhv.90, 100 ),
          metro.mhv.pct.00 = ntile( mhv.00, 100 ),
          metro.median.pay.90 = median( hinc90, na.rm=T ),
          metro.median.pay.00 = median( hinc00, na.rm=T ),
          metro.race.rank.90 = ntile( (100-p.white.90), 100 ) ) %>%
  ungroup() %>%
  mutate( metro.mhv.pct.change = metro.mhv.pct.00 - metro.mhv.pct.90,
          pay.change = metro.median.pay.00 - metro.median.pay.90,
          race.change = p.white.00 - p.white.90,
          mhv.change = mhv.00 - mhv.90 )
```


 

```{r}
d3 <-           
  d3 %>%
  select( c( "tractid", "cbsa", "cbsaname",
             "mhv.00", "mhv.90", "mhv.change","pct.change",
             "p.white.00", "p.black.00", "p.hisp.00", "p.asian.00", 
             "p.hs.edu.00", "p.col.edu.00", "p.prof.00",  "p.unemp.00", 
             "pov.rate.00", "p.white.90", "p.black.90", "p.hisp.90", 
             "p.asian.90", "p.hs.edu.90", "p.col.edu.90", "p.prof.90", 
             "p.unemp.90", "pov.rate.90", "metro.mhv.pct.00", 
             "metro.mhv.pct.90", "metro.median.pay.00", "metro.median.pay.90", 
             "metro.mhv.pct.change", "pay.change", "race.change") ) 

head( d3 ) %>% pander()
```




```{r}

d3 <- data.frame(d3)
stargazer( d3, 
           type=s.type, 
           digits=0, 
           summary.stat = c("min", "p25","median","mean","p75","max") )

```

#Operationalizing Gentrification



```{r}

# incomes less than average metro income in 1990
low.income.1990 <- d3$metro.median.pay.90 < 32924   

# tracts with less than average percent of white population in 1990
diverse.1990 <- d3$p.white.90 < 74
  
# tracts with an increase in income greater than the average increase between 1990 and 2000
increase.income <- d3$pay.change > 12130   

  
loss.diversity <- d3$race.change > 0

# gentrification candidates start at a low income level with high diversity
num.candidates <- sum(low.income.1990 & diverse.1990, na.rm = T)

# When there is a quick increase in income and loss of diversity, the gentrification is at its peak level. 
# num.gentrified are num.candidates that experience increase in income and loss of diversity.

g.flag <- low.income.1990 & diverse.1990 & increase.income & loss.diversity
num.gentrified <- sum(g.flag, na.rm = T)

num.candidates
```

```{r}
num.gentrified
```
```{r}
num.gentrified/num.candidates
```


#Part 03 - Spatial Patterns

```{r}
# devtools::install_github( "sjewo/cartogram" )
# install.packages( "tmap" )

library(tidycensus)
library( geojsonio )  # read geoJSON map files from GitHub
library( cartogram )  # spatial maps w/ tract size bias reduction
library( tmap )       # thematic maps
library( maptools )   # spatial object manipulation 
library( sf )         # 'simple features' flavor of shapefiles

```


```{r}

crosswalk <- read.csv( "https://raw.githubusercontent.com/DS4PS/cpp-529-master/master/data/cbsatocountycrosswalk.csv",  stringsAsFactors=F, colClasses="character" )

# search for city names by strings, use the ^ anchor for "begins with" 

grep( "^ATL", crosswalk$msaname, value=TRUE ) 
```
```{r}

#load your census API key:
key <- "5907687130b29e2e2743ae171b925a66a648498b"
census_api_key (key)
```


```{r}
these.atl <- crosswalk$msaname == "ATLANTA, GA"
these.fips <- crosswalk$fipscounty[these.atl]
these.fips <- na.omit(these.fips)

state.fips <- substr(these.fips, 1, 2)
county.fips <- substr(these.fips, 3, 5)

atl.pop <- 
  get_acs( geography = "tract", variables = "B01003_001",
           state = "13", county = county.fips[state.fips=="13"],
           geometry = TRUE) %>%
           select(GEOID, estimate) %>%
           rename(POP=estimate)
```

#Add Census Data

```{r}
URL <- "https://github.com/DS4PS/cpp-529-master/raw/master/data/ltdb_std_2010_sample.rds"
census.dat <- readRDS(gzcon(url( URL )))

# can merge an object and data.frame
atl <- merge( atl.pop, census.dat, by.x="GEOID", by.y="tractid" )


# make sure there are no empty polygons
atl <- atl[ ! st_is_empty( atl ) , ]

```


#Transform the Shapefile into A Dorling Cartogram

```{r}
# convert sf map object to an sp version
atl.sp <- as_Spatial( atl )

class( atl.sp )
```

```{r}
plot(atl.sp)
```


```{r}
# project map and remove empty tracts
atl.sp <- spTransform( atl.sp, CRS("+init=epsg:3395"))
atl.sp <- atl.sp[ atl.sp$POP != 0 & (! is.na( atl.sp$POP )) , ]

# convert census tract polygons to dorling cartogram
# no idea why k=0.03 works, but it does - default is k=5
atl.sp$pop.w <- atl.sp$POP / 9000 # max(atl.sp$POP)   # standardizes it to max of 1.5
atl_dorling <- cartogram_dorling( x=atl.sp, weight="pop.w", k=0.05 )
plot( atl_dorling )

```


```{r}
tm_shape( atl_dorling ) + 
  tm_polygons( size="POP", col="hinc12", n=7, style="quantile", palette="Spectral" ) 

```





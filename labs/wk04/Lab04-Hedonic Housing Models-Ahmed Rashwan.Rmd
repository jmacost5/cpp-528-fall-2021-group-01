---
title: "Lab04-Hedonic Housing Models-Ahmed Rashwan"
author: "Ahmed Rashwan"
date: "11/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

library( plyr)
library( dplyr )       # data wrangling
library( pander )      # nice tables 
library( mclust )      # cluster analysis 
library( ggplot2 )     # graphing 

library( DT )          # provides an R interface to the JavaScript library DataTables
library( knitr )       # Provides a general-purpose tool for dynamic report generation
library( stargazer )   # create a summary statistics table
library( scales )      # inverse of scaling, making guides (legends and axes) 

# maps
library( tidycensus)   # help R users get Census data that is pre-prepared for exploration
library( pals )        # Memory use is reduced by compressing colormaps to fewer colors
library( cartogram )   # spatial maps w/ tract size bias reduction
library( tidyverse)    # tidyverse makes data science faster, easier and more fun with
library( here)  
library(formattable)

customGreen0 = "#DeF7E9"

customGreen = "#71CA97"

customRed = "#ff7f7f"

```

```{r}
# set randomization seed ----
set.seed( 1234 )
# load necessary functions and objects ----
# note: all of these are R objects that will be used throughout this .rmd file
import::here("S_TYPE",
             "panel.cor",
             "panel.smooth",
             "jplot",
             "d",
             "df",
             "cbsa_stats_df",
             # notice the use of here::here() that points to the .R file
             # where all these R objects are created
             .from = here::here("labs/wk04/lab_04_source.R"),
             .character_only = TRUE)
```

### Part 1 

####Create a dataset that includes 2000 and 2010 census variables drop all rural census tracts.

#### Loading Data

```{r}

# note: please do not use static file paths
# note: notice down below the use of here::here()
d1 <- readRDS( here::here( "data/rodeo/LTDB-2000.rds" ) )
d2 <- readRDS( here::here( "data/rodeo/LTDB-2010.rds" ) )
md <- readRDS( here::here( "data/rodeo/LTDB-META-DATA.rds" ) )

# check to make sure we are not losing 
# or gaining observations in the merge

#### Mergaing Data Sets
d1 <- select( d1, - year )
d2 <- select( d2, - year )

d <- merge( d1, d2, by="tractid" )
d <- merge( d, md, by="tractid" )

nrow( d1 ) 

```


#### Filter Rural Districts

```{r}

d <- filter( d, urban == "urban" )

```

#### save a copy of data for later use

```{r}

d.full<- d 

```

Store original in case you need to reset anything

```{r}

d <- d.full 

```

```{r}

df.select <- select( df, MedianHomeValue2010, MHV.Change.00.to.10,MHV.Growth.00.to.12)

formattable(head(df.select), 
            align =c("l","c","c","c","c", "c", "c", "c", "r"), 
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")),
              `MedianHomeValue2010`= color_tile(customGreen0, customGreen0),
              `MHV.Change.00.to.10`= color_tile(customGreen, customGreen),
              `MHV.Growth.00.to.12`= color_tile(customRed, customRed)
))

```
### Part 1 - Data

#### Create a variable that measures the growth of median home value from 2000 to 2010.

```{r}

d <- select( d, tractid, mhmval00, mhmval12, hinc00, hinc12, col00, col12,
            prof00, prof12, incpc00, incpc12, hs00, hs12, unemp00, unemp12, 
            wds00, wds12,clf00, ag25up00, empclf00, empclf12, ag25up12, clf12, 
            ag15up12, ag15up00,hu00 , vac00, own00, rent00, h30old00, empclf00,
            family00 ,dpov00, npov00,pop00.x, nhwht00,nhblk00, hisp00, asian00, 
            cbsa, cbsaname) 

 
d <- 
  d %>%
  mutate( # percent white in 2000
          p.white = 100 * nhwht00 / pop00.x,
          # percent black in 2000
          p.black = 100 * nhblk00 / pop00.x,
          # percent hispanic in 2000
          p.hisp = 100 * hisp00 / pop00.x, 
          # percent asian in 2000
          p.asian = 100 * asian00 / pop00.x,
          # percent Multi-family house  in 2000
          p.family = 100 * family00 / pop00.x,
          # percent rental house  in 2000
          p.rental = 100 * rent00 / pop00.x,
          # percent owner-occupied units in 2000
          p.owned = 100 * own00 / pop00.x,
          # percent high school grads by age 25 in 2000 
          p.hs = 100 * (hs00+col00) / ag25up00,
          # percent pop with college degree in 2000
          p.col = 100 * col00 / ag25up00,
          # percent employed in professional fields in 2000
          p.prof = 100 * prof00 / empclf00,
          # percent unemployment  in 2000
          p.unemp = 100 * unemp00 / clf00,
          # percent of housing lots in tract that are vacant in 2000
          p.vacant = 100 * vac00 / hu00,
          # dollar change in median home value 2000 to 2010 
          pov.rate = 100 * npov00 / dpov00 , 
          # Percent of dollar change in median home value 2000 to 2010
          pov.rate.percent = pov.rate / 100, 
          # Median Home Values change between 2000 to 2010
          mhv.change.00.to.10 = mhmval12 - mhmval00 , 
          # Percent of Median Home Values change from 2000 to 2010
          p.mhv.change = 100 *(mhmval12 - mhmval00)/mhmval00)


# adjust 2000 home values for inflation 
mhv.00 <- d$mhmval00 * 1.28855  
mhv.10 <- d$mhmval12

# change in MHV in dollars
mhv.change <- mhv.10 - mhv.00

# drop cases where value decrease by more than $10,000 
mhv.change[ mhv.change < -10000 ] <- NA


# change in MHV in percent
mhv.growth <- 100 * ( mhv.change / mhv.00 )

# drop cases where growth exceeds 200% 
mhv.growth[ mhv.growth > 200 ] <- NA 


# change in MHV in percent
mhv.growth <- 100 * (mhv.change/mhv.00)

# eliminate the tracts with MHV growth of more than 200%
mhv.00[mhv.growth > 200] <- NA

d$mhv.00 <- mhv.00
d$mhv.10 <- mhv.10
d$mhv.change <- mhv.change
d$mhv.growth <- mhv.growth 


```

#### Omit cases that have a median home value less than $10,000 in 2000.

```{r}

mhv.00[mhv.00 < 10000] <- NA


```

#### Omit cases with growth rates above 200%.

```{r}

mhv.00[mhv.growth > 200] <- NA

```

#### Median Home value

```{r}
hist( df$MedianHomeValue2000, breaks=200, xlim=c(0,500000), 
      col="gray20", border="white",
      axes=F, 
      xlab="MHV (median = $138k)",
      ylab="",
      main="Median Home Value in 2000 (2010 US dollars)" )
axis( side=1, at=seq(0,500000,100000), 
      labels=c("$0","$100k","$200k","$300k","$400k","$500k") )
abline( v=median( df$MedianHomeValue2000, na.rm=T ), col="orange", lwd=3 )

```

#### Growth in Home Value by Census Tract 2000 to 2010

```{r}

hg <-
hist( df$MHV.Growth.00.to.12, breaks=5000, 
      xlim=c(-100,200), yaxt="n", xaxt="n",
      xlab="", cex.main=1.5,
      ylab="", main="Growth in Home Value by Census Tract 2000 to 2010",
      col="gray40", border="white" )
axis( side=1, at=seq( from=-100, to=200, by=50 ), 
      labels=paste0( seq( from=-100, to=200, by=50 ), "%" ) )
ymax <- max( hg$count )
        
mean.x <- mean( df$MHV.Growth.00.to.12, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=100, y=(0.5*ymax), 
      labels=paste0( "Mean = ", round(mean.x,0), "%"), 
      col="darkorange", cex=1.8, pos=4 )
median.x <- median( df$MHV.Growth.00.to.12, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=100, y=(0.6*ymax), 
      labels=paste0( "Median = ", round(median.x,0), "%"), 
      col="dodgerblue", cex=1.8, pos=4 )

```

#### Change in Median Home Value \n2000 to 2010

```{r}

hist( df$MHV.Change.00.to.10/1000, breaks=500, 
      xlim=c(-100,500), yaxt="n", xaxt="n",
      xlab="Thousand of US Dollars (adjusted to 2010)", cex.lab=1.5,
      ylab="", main="Change in Median Home Value 2000 to 2010",
      col="gray20", border="white" )
axis( side=1, at=seq( from=-100, to=500, by=100 ), 
      labels=paste0( "$", seq( from=-100, to=500, by=100 ), "k" ) )
        
mean.x <- mean( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=200, y=1500, 
      labels=paste0( "Mean = ", dollar( round(1000*mean.x,0)) ), 
      col="darkorange", cex=1.8, pos=3 )
median.x <- median( df$MHV.Change.00.to.10/1000, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=200, y=2000, 
      labels=paste0( "Median = ", dollar( round(1000*median.x,0)) ), 
      col="dodgerblue", cex=1.8, pos=3 )

```

### Part 2 - Predict MHV Change

#### Select at least three census variables that you feel will be good predictors of change in MHV between 2000 and 2010.

**1-Percent white (p.white)**

**2-Percent professional employees (p.prof)**

**3-Percent of properties vacant in year 2000 (p.vacant)**

#### Run the model while including metro-level fixed effects (cbsa name or FIPS). Make sure you check for variable skew and multicollinearity and adjust accordingly.

#### Variables Skew

```{r}

hist( d$p.white )

```

```{r}

hist( d$p.prof )

```

```{r}

hist( d$p.vacant )

```

**Vacant properties variable is skewed to be logged**

```{r}
d$p.vacant.log <- log( d$p.vacant + 1 )
hist( d$p.vacant.log )
```

#### Addressing Skew in Census Data:

```{r}
# create subset to visualize in correlation matrix 
d2 <- select( d, p.white , p.prof , p.vacant )
# reduce data density for visualization
set.seed( 1234 )
d3 <- sample_n( d2, 10000 ) %>% na.omit()
# correlation plots
pairs( d3, upper.panel=panel.cor, lower.panel=panel.smooth )

```
**After applying log transformations note that the bivariate correlations increase except for relationship between MHV and (mhv.growth) vacancy rates (p.vacant):**

```{r}

set.seed( 1234 )
d2 <- select( d, mhv.growth, p.white, p.prof,  p.vacant )
# recode some vars to remove outliers and skew
d2$mhv.growth[ d2$mhv.growth > 200 ] <- NA
d2$p.white <- log10( d2$p.white + 1 )
d2$p.prof <- log10( d2$p.prof + 1  )
d2$p.vacant <- log10( d2$p.vacant + 1 )
d4 <- sample_n( d2, 5000 ) %>% na.omit()
pairs( d4, upper.panel=panel.cor, lower.panel=panel.smooth )

```


#### check multicollinearity between variables

```{r}

cor( d$p.white, d$p.prof, use="pairwise.complete" )

```

```{r}

cor( d$p.white, d$p.vacant.log, use="pairwise.complete" )

```

```{r}

cor( d$p.prof, d$p.vacant.log, use="pairwise.complete" )

```

##### Create a correlation plot for your three variables to check wether some variables are highly-correlated?

**Answer : None of the variables has a correlation above that cases Multicollinearity **

#### Create a relationship scatterplot between each variable & MHV Growth 2000-2010

```{r}

jplot( d$p.white, d$mhv.growth, ylim=c(-100,200), 
       lab1="Percent White", lab2="MHV Growth 2000-2010" )

```

```{r}

jplot( d$p.prof, d$mhv.growth, ylim=c(-100,200), 
       lab1="Percent Professional employees", lab2="MHV Growth 2000-2010" )

```

```{r}

jplot( d$p.vacant.log, d$mhv.growth, ylim=c(-100,200), 
       lab1="Percent Vacant Properties", lab2="MHV Growth 2000-2010" )

```

### Interpret a Regression Coefficient.

```{r}

reg.data <- d
# remove outliers and skew
reg.data$mhv.growth[ reg.data$mhv.growth > 200 ] <- NA
reg.data$p.white <- log10( reg.data$p.white + 1 )
reg.data$p.prof <- log10( reg.data$p.prof + 1 )
reg.data$p.vacant.log  <- log10( reg.data$p.vacant  + 1 )

m1 <- lm( mhv.growth ~  p.white , data=reg.data )
m2 <- lm( mhv.growth ~  p.prof, data=reg.data )
m3 <- lm( mhv.growth ~  p.vacant.log, data=reg.data )
m4 <- lm( mhv.growth ~  p.white  + p.prof + p.vacant.log, data=reg.data )


stargazer( m1, m2, m3, m4 ,
           type=S_TYPE, digits=2,
           omit.stat = c("rsq","f") )

```


### Descriptives

```{r}

df <- data.frame( MedianHomeValue2000=mhv.00, 
                  MedianHomeValue2010=mhv.10, 
                  MHV.Change.00.to.10=mhv.change,
                  MHV.Growth.00.to.12=mhv.growth, 
                  Percent.White=d$p.white,
                  Percent.Professional=d$p.prof,
                  Percent.Vacant=d$p.vacant.log)

stats.for.table <- c("min", "p25","median","mean","p75","max")

stargazer( df, 
           type=S_TYPE, 
           digits=0, 
           summary.stat = stats.for.table )

```

#### view results

```{r}

cbsa_stats_df %>% head()

```

```{r}
d5 <- filter( d, cbsaname %in% 
                c("Abilene, TX",
                  "Albany-Schenectady-Troy, NY",
                  "Alexandria, LA") )
d5$cbsaname <- factor( d5$cbsaname, labels=c("Ty-NY","Alx-LA","Abl-TX") )
par( mar=c(4,6,4,6), mfrow=c(1,2) )
plot( d5$cbsaname,  d5$mhv.00, las=1, frame.plot=F, outline=F,
      xlab="", ylab="", main="Home Values in 2000" )
abline( h=seq(0,1200000,100000), lty=3, col=gray(0.5,0.3) )
axis( side=4, las=1 )
plot( d5$cbsaname,  d5$p.prof, las=1, frame.plot=F, outline=F,
      xlab="", ylab="", main="Professionals Rates in 2000" )
abline( h=seq(0,15,1), lty=3, col=gray(0.5,0.3) )
axis( side=4, las=1 )

```


```{r}

d5 <- filter( d, cbsaname %in%
                c("Abilene,TX",
                  "Albany-Schenectady-Troy, NY",
                  "Alexandria, LA") )
d5$mhv.growth[ d5$mhv.growth > 200 ] <- NA
d5$p.prof <- log10( d5$p.prof + 1 )
x <- rnorm( nrow(d5), 0, 0.1 ) +
     as.numeric( d5$cbsaname == "Abilene, TX" ) + 
     2 * as.numeric( d5$cbsaname == "Albany-Schenectady-Troy, NY" ) + 
     3* as.numeric( d5$cbsaname == "Alexandria, LA" ) 
par( mfrow=c(1,2) )
plot( x, d5$mhv.growth, 
      pch=19, cex=1.5, bty = "n",  
        col=factor(d5$cbsa),
      ylim=c(-50,50),
      xaxt="n", 
      ylab="", xlab="",
      main="MHV Growth")
axis( side=1, at=1:3, labels=c("Abilene","Schenectady","Alexandria"), 
      tick=F, col.axis="gray60", cex.axis=1.3 )
plot( x, d5$p.prof, 
      pch=19, cex=1.5, bty = "n",  
        col=factor(d5$cbsa),
      # ylim=c(0,40),
      xaxt="n", 
      ylab="", xlab="",
      main="Professionals (logged)")
axis( side=1, at=1:3, labels=c("Abilene","Schenectady","Alexandria"), 
      tick=F, col.axis="gray60", cex.axis=1.3 )

```
**result in different baseline metro-level home value growth rates in a model when each city is given its own intercep**

```{r}

d5 <- filter( d, cbsaname %in% 
              c("Abilene, TX",
                 "Albany-Schenectady-Troy, NY",
                 "Alexandria, LA") )

d5$mhv.growth[ d5$mhv.growth > 200 ] <- NA
d5$p.prof <- log10( d5$p.prof + 1 )
m <- lm( mhv.growth ~ factor(cbsaname) + p.prof - 1, data=d5 )
b0.Abilene   <- m$coefficients[1] 
b0.Schenectady    <- m$coefficients[2] 
b0.Alexandria <- m$coefficients[3] 
b1            <- m$coefficients[4] 
palette( c( "steelblue", "green3", "darkorange"  ) )
palette( adjustcolor( palette(), alpha.f = 0.3 ) )
plot( d5$p.prof, d5$mhv.growth,
        pch=19, cex=1.5, bty = "n",  
        col=factor(d5$cbsa),
      ylim=c(-100,100),
      xlab="Professionals Rate (logged)",
      ylab="Median Home Value Growth 2000-2010")
          
abline( b0.Abilene, b1, col="steelblue", lwd=3 )
abline( b0.Schenectady, b1, col="green3", lwd=3 )
abline( b0.Alexandria, b1, col="darkorange", lwd=3 )


```

**We account for context by adding a metro-level fixed effect to the model. Alternatively, we can add the average median home value growth of the metro area as a control variable:**

```{r}

d.reg <- d
d.reg$mhv.growth[ d.reg$mhv.growth > 200 ] <- NA
d.reg$p.prof <- log10( d.reg$p.prof + 1 )
# average growth in median home value for the city
d.reg <- 
  d.reg %>%
  group_by( cbsaname ) %>%
  mutate( metro.mhv.growth = 100 * median( mhv.growth, na.rm=T ) ) %>%
  ungroup() 
m1 <- lm( mhv.growth ~ p.prof, data=d.reg )
m2 <- lm( mhv.growth ~ p.prof + metro.mhv.growth, data=d.reg )
m3 <- lm( mhv.growth ~ p.prof + cbsa, data=d.reg )
stargazer( m1, m2, m3, 
           type=S_TYPE, digits=2,
           omit.stat = c("rsq","f"),
           omit="cbsa",
           add.lines = list(c("Metro Fixed Effects:", "NO", "NO","YES")) )


```

##### What are the results? Which factor was most important? Did it meet your expectations? Were there any variables that were not significant that you expected to be?

##### Explain your findings to a general audience.

**The relationship between the number of people employed in high-paying professional professions and the growth in property prices had the predicted beneficial effect.**

**The proportion of white people in the tract was the total opposite of what was predicted. In 2000, there were more white people, which predicted smaller gains in property value and growth rates between 2000 and 2010.**

**The relationship between housing vacancy and growth turned out to be more complicated than expected.**

**All three relationships are statistically significant at an alpha=0.05 level.**










---
title: 'Lab 03: Descriptive Analysis'
author: "Erin McIntyre"
date: "11/2/2021"
output:
   html_document:
    theme: readable
    df_print: paged
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Import Package, include=FALSE}

# Install import package
# install.packages("import")

#load and unload here package to reset it for use in the lab
library(here)
detach("package:here", unload = TRUE)

```


```{r Packages 1, include=FALSE}

library( dplyr )
library( import )
library( here )
library( knitr )
library( pander )
library( Rcpp )
library( scales )
library( stargazer )
library( ggplot2 )

import::here("jplot",
             # notice the use of here::here() that points to the .R file
             # where all these R objects are created
             .from = here::here("labs/wk03/wk03_utilities.R"),
             .character_only = TRUE)


# import::here("jplot",
            # .from = here::here("analysis/helper_functions_em.R"),
            # .character_only = TRUE)
# Retrieving the jplot function from the helper_functions_em.R file did not work for some reason.
```



# Part 01 - Descriptive Analysis

```{r S TYPE}

# s.type <- "text" for RMD file
# s.type <- "html" for knitting HTML file

s.type <- "text"

```


```{r}

# Load cleaned data using here::here()

d1 <- readRDS( here::here( "data/rodeo/LTDB-1990.rds" ) )
d2 <- readRDS( here::here( "data/rodeo/LTDB-2000.rds" ) )
md <- readRDS( here::here( "data/rodeo/LTDB-META-DATA.rds" ) )

# check to make sure we are not losing 
# or gaining observations in the merge
nrow( d1 ) 

```

```{r}

d1 <- select( d1, - year )
d2 <- select( d2, - year )

d <- merge( d1, d2, by="tractid" )
d <- merge( d, md, by="tractid" )


# Number of rows should match d1 above
nrow( d )

```

## Filter Rural Districts

```{r}

table( d$urban )

d <- filter( d, urban == "urban" )

```

## Identify Common Variables

```{r}

# find variables that are in both files
compare_dfs <- function( df1, df2 )
{
  # use regular expressions to remove numeric suffixes 
  var.names.1 <- names( df1 )
  var.names.1 <- gsub( "[.][xy]$", "", var.names.1 )
  var.names.1 <- gsub( "[0-9]{2}$", "", var.names.1 )
  
  var.names.2 <- names( df2 )
  var.names.2 <- gsub( "[.][xy]$", "", var.names.2 )
  var.names.2 <- gsub( "[0-9]{2}$", "", var.names.2 )
  
  shared <- intersect( var.names.1, var.names.2 ) %>% sort()
  print( "SHARED VARIABLES:")
  print( shared )
  
  not.shared <- c( setdiff( var.names.1, var.names.2 ),
                   setdiff( var.names.2, var.names.1 ) ) %>% sort()
  
  print( "NOT SHARED:" )
  print( not.shared )
  
  d.vars1 <- data.frame( type="shared", variables=shared, stringsAsFactors=F )
  d.vars2 <- data.frame( type="not shared", variables=not.shared, stringsAsFactors=F )
  dd <- rbind( d.vars1, d.vars2 )
  
  return( dd )
}

vars <- compare_dfs( df1=d1, df2=d2 )

```


```{r}

head( vars )

```

## Create Dataset for Analysis

```{r}

d.full <- d  # keep a copy to avoid having to reload 

```


```{r}

d <- d.full  # store original in case you need to reset anything

d <- select( d, tractid, mhmval90, mhmval00, hinc90, 
             hu90, own90, rent90,  
             empclf90, clf90, unemp90, prof90,  
             dpov90, npov90,
             ag25up90, hs90, col90, 
             pop90.x, nhwht90, nhblk90, hisp90, asian90,
             cbsa, cbsaname )
d <- 
  d %>%
  mutate( p.white = 100 * nhwht90 / pop90.x,
          p.black = 100 * nhblk90 / pop90.x,
          p.hisp = 100 * hisp90 / pop90.x, 
          p.asian = 100 * asian90 / pop90.x,
          p.hs = 100 * (hs90+col90) / ag25up90,
          p.col = 100 * col90 / ag25up90,
          p.prof = 100 * prof90 / empclf90,
          p.unemp = 100 * unemp90 / clf90,
          pov.rate = 100 * npov90 / dpov90 )

```



```{r}

stargazer( d, 
           type=s.type, 
           digits=0,
           summary.stat = c("min", "p25","median","mean","p75","max") )

```


## Exploration of Median Home Value

```{r}

# adjust 1990 home values for inflation 
mhv.90 <- d$mhmval90 * 1.31 
mhv.00 <- d$mhmval00

mhv.change <- mhv.00 - mhv.90

df <- data.frame( MedianHomeValue1990=mhv.90, 
                  MedianHomeValue2000=mhv.00, 
                  Change.90.to.00=mhv.change )

stargazer( df, 
           type=s.type, 
           digits=0, 
           summary.stat = c("min", "p25","median","mean","p75","max") )

```

## Histogram of MHV


```{r}

hist( mhv.change/1000, breaks=500, 
      xlim=c(-100,500), yaxt="n", xaxt="n",
      xlab="Thousand of US Dollars (adjusted to 2000)", cex.lab=1.5,
      ylab="", main="Change in Median Home Value 1990 to 2000",
      col="gray20", border="white" )

axis( side=1, at=seq( from=-100, to=500, by=100 ), 
      labels=paste0( "$", seq( from=-100, to=500, by=100 ), "k" ) )
        
mean.x <- mean( mhv.change/1000, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=200, y=1500, 
      labels=paste0( "Mean = ", dollar( round(1000*mean.x,0)) ), 
      col="darkorange", cex=1.8, pos=3 )

median.x <- median( mhv.change/1000, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=200, y=2000, 
      labels=paste0( "Median = ", dollar( round(1000*median.x,0)) ), 
      col="dodgerblue", cex=1.8, pos=3 )

```


```{r}

layout.matrix <- matrix( c( 1,3,
                            2,3 ), 
                nrow=2, ncol=2, byrow=T )

layout( mat = layout.matrix,
        heights = c(2,2), # Heights of the two rows
        widths =  c(3,4)) # Widths of the two columns

# layout.show(3)

par( mar=c(4,0,0,2) )

hist( mhv.90/1000, breaks=50, 
      xlim=c(-200,800), yaxt="n", xaxt="n",
      xlab="", cex.lab=1,
      ylab="", main="",
      col="darkslateblue", border="white" )

axis( side=1, at=seq( from=0, to=1000, by=100 ), 
      labels=paste0( "$", seq( from=0, to=1000, by=100 ), "k" ) )

abline( v=seq(0,1000,100), lty=2, col="gray80" )

text( 550, 4000, labels="Median Home \nValue in 1990", 
      col="darkslateblue", cex=1.8 )



hist( mhv.00/1000, breaks=50, 
      xlim=c(-200,800), yaxt="n", xaxt="n",
      xlab="", cex.lab=1,
      ylab="", main="",
      col="darkslateblue", border="white" )

abline( v=seq(0,1000, 100 ), lty=2, col="gray80" )

text( 550, 3500, labels="Median Home \nValue in 2000", 
      col="darkslateblue", cex=1.8 )

axis( side=1, at=seq( from=0, to=1000, by=100 ), 
      labels=paste0( "$", seq( from=0, to=1000, by=100 ), "k" ) )


# data reduction - filter 1,000 observations

df <- data.frame( v90=mhv.90/1000, v00=mhv.00/1000 )
df <- sample_n( df, 1000 )

par( mar=c(4,5,3,2) )

jplot( df$v90, df$v00, aes(lab1="MHV in 1990", lab2="MHV in 2000",
       xlim=c(0,1000), ylim=c(0,1000),
       axes=F) )

abline( a=0, b=1, lty=2, col="gray" )
axis( side=1, at=seq( from=0, to=1000, by=200 ), 
      labels=paste0( "$", seq( from=0, to=1000, by=200 ), "k" ) )
axis( side=2, at=seq( from=0, to=1000, by=200 ), 
      labels=paste0( "$", seq( from=0, to=1000, by=200 ), "k" ) )

```

## Change in MHV 1990-2000


```{r}

mhv.90[ mhv.90 < 10000 ] <- NA
pct.change <- mhv.change / mhv.90
summary( pct.change )

```


```{r}

# how many cases had increases above 500%
sum( pct.change > 5, na.rm=T )

```



```{r}

# preview tracts with large increases in home values 
# to see if increases make sense 

d %>% 
  filter( pct.change > 5 ) %>% 
  head() %>% pander()

```


```{r}

# Plot the percent change variable

hg <-
hist( pct.change, breaks=2000, 
      xlim=c(-1,2), yaxt="n", xaxt="n",
      xlab="", cex.main=1.5,
      ylab="", main="Growth in Home Value by Census Tract 1990 to 2000",
      col="gray40", border="white" )

axis( side=1, at=seq( from=-1, to=2, by=0.5 ), 
      labels=paste0( seq( from=-100, to=200, by=50 ), "%" ) )

ymax <- max( hg$count )
        
mean.x <- mean( pct.change, na.rm=T )
abline( v=mean.x, col="darkorange", lwd=2, lty=2 )
text( x=1, y=(0.5*ymax), 
      labels=paste0( "Mean = ", round(100*mean.x,0), "%"), 
      col="darkorange", cex=1.8, pos=4 )

median.x <- median( pct.change, na.rm=T )
abline( v=median.x, col="dodgerblue", lwd=2, lty=2 )
text( x=1, y=(0.6*ymax), 
      labels=paste0( "Median = ", round(100*median.x,0), "%"), 
      col="dodgerblue", cex=1.8, pos=4 )

```


## Group Growth Rates By Metro Data


```{r}

d$mhv.change <- mhv.change 
d$pct.change <- pct.change
d$mhv.00 <- mhv.00
d$mhv.90 <- mhv.90

d %>%
  group_by( cbsaname ) %>%
  summarize( ave.change = median( mhv.change, na.rm=T ),
             ave.change.d = dollar( round(ave.change,0) ),
             growth = 100 * median( pct.change, na.rm=T ) ) %>%
  ungroup() %>%
  arrange( - growth ) %>%
  select( - ave.change ) %>% 
  head( 25 ) %>%
  pander()

```


# Part 02 - Measuring Gentrification


```{r}

# adjust 1990 home values for inflation 
mhv.90 <- d$mhmval90 * 1.31 
mhv.00 <- d$mhmval00

mhv.change <- mhv.00 - mhv.90

# small initial values are skewing percentages
#
# an average home value below $10k is really low -
# these must be mostly vacant lots?

mhv.90[ mhv.90 < 10000 ] <- NA
pct.change <- 100 * ( mhv.change / mhv.90 )
summary( pct.change )

```


```{r}

d.full$mhv.90 <- mhv.90
d.full$mhv.00 <- mhv.00
d.full$mhv.change <- mhv.change
d.full$pct.change <- pct.change

```


```{r}

d3 <- select( d.full, 
             
             tractid, cbsa, cbsaname,            # ids / units of analysis
             
             mhv.90, mhv.00, mhv.change, pct.change,    # home value 
             
             hinc90, hu90, own90, rent90,        # ses
             hinc00, hu00, own00, rent00,
             
             empclf90, clf90, unemp90, prof90,   # employment 
             empclf00, clf00, unemp00, prof00,
             
             dpov90, npov90,                     # poverty
             dpov00, npov00,
             
             ag25up90, hs90, col90,              # education 
             ag25up00, hs00, col00,
             
             pop90.x, nhwht90, nhblk90, hisp90, asian90,   # race
             pop00.x, nhwht00, nhblk00, hisp00, asian00
             
          ) # end select


d3 <- 
  d3 %>%
  mutate( 
          # 1990 variables
          p.white.90 = 100 * nhwht90 / pop90.x,
          p.black.90 = 100 * nhblk90 / pop90.x,
          p.hisp.90 = 100 * hisp90 / pop90.x, 
          p.asian.90 = 100 * asian90 / pop90.x,
          p.hs.edu.90 = 100 * (hs90+col90) / ag25up90,
          p.col.edu.90 = 100 * col90 / ag25up90,
          p.prof.90 = 100 * prof90 / empclf90,
          p.unemp.90 = 100 * unemp90 / clf90,
          pov.rate.90 = 100 * npov90 / dpov90,
          
          # 2000 variables
          p.white.00 = 100 * nhwht00 / pop00.x,
          p.black.00 = 100 * nhblk00 / pop00.x,
          p.hisp.00 = 100 * hisp00 / pop00.x, 
          p.asian.00 = 100 * asian00 / pop00.x,
          p.hs.edu.00 = 100 * (hs00+col00) / ag25up00,
          p.col.edu.00 = 100 * col00 / ag25up00,
          p.prof.00 = 100 * prof00 / empclf00,
          p.unemp.00 = 100 * unemp00 / clf00,
          pov.rate.00 = 100 * npov00 / dpov00 )
d3 <-
  d3 %>%
  group_by( cbsaname ) %>%
  mutate( metro.mhv.pct.90 = ntile( mhv.90, 100 ),
          metro.mhv.pct.00 = ntile( mhv.00, 100 ),
          metro.median.pay.90 = median( hinc90, na.rm=T ),
          metro.median.pay.00 = median( hinc00, na.rm=T ),
          metro.race.rank.90 = ntile( (100-p.white.90), 100 ) ) %>%
  ungroup() %>%
  mutate( metro.mhv.pct.change = metro.mhv.pct.00 - metro.mhv.pct.90,
          pay.change = metro.median.pay.00 - metro.median.pay.90,
          race.change = p.white.00 - p.white.90,
          mhv.change = mhv.00 - mhv.90 )

```


```{r}

d3 <-           
  d3 %>%
  select( c( "tractid", "cbsa", "cbsaname",
             "mhv.90", "mhv.00", "mhv.change","pct.change",
          "p.white.90", "p.black.90", "p.hisp.90", "p.asian.90", 
          "p.hs.edu.90", "p.col.edu.90", "p.prof.90",  "p.unemp.90", 
          "pov.rate.90", "p.white.00", "p.black.00", "p.hisp.00", 
          "p.asian.00", "p.hs.edu.00", "p.col.edu.00", "p.prof.00", 
          "p.unemp.00", "pov.rate.00", "metro.mhv.pct.90", 
          "metro.mhv.pct.00", "metro.median.pay.90", "metro.median.pay.00", 
          "metro.mhv.pct.change", "pay.change", "race.change",
          "metro.race.rank.90") ) 
  
head( d3 ) %>% pander()

```

```{r}

d3 <- data.frame(d3)
stargazer( d3, 
           type=s.type, 
           digits=0, 
           summary.stat = c("min", "p25","median","mean","p75","max") )

```


## Operationalizing Gentrification

Operationalize gentrification and examine its prevalence in the data.

How many census tracts are candidates (start out at a low income level with high diversity)? 
  
  **10,537**

And of those how many have transitioned into advanced stages of gentrification?
  
  **414**

Provide an explanation and justification of the way you measure gentrification in the data.

```{r}

## look at notes and example code and make my own gentrification indicators

# poverty rates greater than average in 1990
# poor.1990 <- d3$pov.rate.90 > 12

# incomes less than average metro income in 1990
low.income.1990 <- d3$metro.median.pay.90 < 32924   

# tracts with less than average percent of white population in 1990
diverse.1990 <- d3$p.white.90 < 74
  
# tracts with an increase in income greater than the average increase between 1990 and 2000
increase.income <- d3$pay.change > 12130   

# Most tracts seem to be experiencing a decrease in the white population with the mean being -8 and the median being -5. Because of this, any increase in the white population after 1990 would be significant compared to the average growth.  
loss.diversity <- d3$race.change > 0



# gentrification candidates start at a low income level with high diversity
num.candidates <- sum(low.income.1990 & diverse.1990, na.rm = T)

# Tracts that have transitioned into advanced stages of gentrification will experience a quick rise in income and decrease in diversity. 
# num.gentrified are num.candidates that experience increase in income and loss of diversity.

g.flag <- low.income.1990 & diverse.1990 & increase.income & loss.diversity
num.gentrified <- sum(g.flag, na.rm = T)

num.candidates
num.gentrified
num.gentrified/num.candidates
```


**Only 3.9 percent of urban tracts experienced gentrification between 1990 and 2000.**


## Discussion

What do you think? Is that the right way to operationalize it? Do you care about relative diversity (more diverse neighborhood than rest of the city) or absolute (percentage of non-whites regardless of city diversity).

Do we care about absolute increase in value, or relative to the national average? The national average would include all of the gentrifying tracts, which could skew it upward and thus make it a poor benchmark? Maybe look at the average increase in value for non-gentrification candadidates?





# Part 03 - Spatial Visualization

Questions to answer:

**Home Values**

Describe the distribution of home values in 1990 - where are high and low-value tracts located in the city/cities?
Compare values in 2000 to changes in values from 1990-2000. Do the largest gains occur in tracts with above or below-average home prices in 2000?

**Gentrification**

create a map that highlights tracts that are candidates for gentrification in 2000 and tracts that gentrify between 1990 and 2000.


```{r Packages, include=FALSE}
library( geojsonio )  
library( sp )          
library( sf )          
library( mclust )       
library( tmap )        
library( ggplot2 )     
library( ggthemes )    
library( dplyr )      
library( pander )      
library( tidycensus )

library( cartogram ) 
library( maptools ) 
library(lobstr)
```


## Step 1: Select Your MSA

```{r}

crosswalk <- read.csv( "https://raw.githubusercontent.com/DS4PS/cpp-529-master/master/data/cbsatocountycrosswalk.csv",  stringsAsFactors=F, colClasses="character" )


grep( "^NEW O", crosswalk$msaname, value=TRUE ) 

```

## Step 2: Download Shapefile

```{r}
census_api_key("19536e52473d3d9d0e69e5ea8e7804626ac08460")
```

```{r, results='hide'}
these.msp <- crosswalk$msaname == "NEW ORLEANS, LA"
these.fips <- crosswalk$fipscounty[ these.msp ]
these.fips <- na.omit( these.fips )

state.fips <- substr( these.fips, 1, 2 )
county.fips <- substr( these.fips, 3, 5 )

new.o <-
get_acs( geography = "tract", variables = "B01003_001",
         state = "22", county = county.fips[state.fips=="22"], geometry = TRUE ) %>% 
         select( GEOID, estimate ) %>%
         rename( POP=estimate )

```

## Step 3: Add Census Data

```{r}

# create small dataframe for the merge
df <- data.frame(  tractid=d$tractid, 
        mhv.90,  mhv.00,  mhv.change,  pct.change  )


# create a geoID for merging by tract 
df$GEOID <- substr( df$tractid, 6, 18 )  # extract codes
df$GEOID <- gsub( "-", "", df$GEOID )    # remove hyphens
class( df$GEOID )

head( df$GEOID )

```


```{r}

# head( new.o@data )  # sp class from GIS file, so data frame is located @data

# produces error
# Error in head(new.o@data) : 
#  trying to get slot "data" from an object (class "sf") that is not an S4 object

```
```{r}

# merge census data with dorling map

nrow(new.o)

new.o <- merge( new.o, df, by.x="GEOID", by.y="GEOID" )

# make sure they have not changed or 
# you are missing rows in your data frame
# or merging with the wrong ID
nrow(new.o)



```




## Step 4: Transform Shapefile

```{r}

new.o.sp <- as_Spatial( new.o )

```

```{r}

new.o.sp <- spTransform( new.o.sp, CRS("+init=epsg:3395"))

bb <- st_bbox(c(xmin = -10060556, xmax = -10002885,
                ymax = 3501976, ymin = 3451225),
              crs = st_crs("+init=epsg:3395"))

#tm_shape( new.o.sp, bbox=bb ) + 
#  tm_polygons( col="mhv.90", n=10, style="quantile", palette="Spectral" ) +
#  tm_layout( "Dorling Cartogram", title.position=c("right","top") )

# produces error
# Error: Fill argument neither colors nor valid variable name(s)
```



```{r}

#tm_shape( new.o.sp, bbox=bb ) + 
#  tm_polygons( col="mhv.change", n=10, style="quantile", palette="Spectral" ) +
#  tm_layout( "Dorling Cartogram", title.position=c("right","top") )

# produces error
# Error: Fill argument neither colors nor valid variable name(s)

```


```{r}

#tm_shape( new.o.sp, bbox=bb ) + 
#  tm_polygons( col="pct.change", n=10, style="quantile", palette="Spectral" ) +
#  tm_layout( "Dorling Cartogram", title.position=c("right","top") )

# produces error
# Error: Fill argument neither colors nor valid variable name(s)

```


